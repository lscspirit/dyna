<html>
<head>
  <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
  <script src="https://fb.me/react-0.13.3.js"></script>
  <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="../../dyna.js"></script>
  <script src="store.js"></script>
  <script type="text/jsx">
    'use strict';

    (function(dyna, React) {

      //
      // Actions
      //

      var action_names = {
        CLICKED: 'buzzer-clicked'
      };
      window.action_factory = dyna.createActionFactory(action_names, {
        buzzClick: function() {
          return this.createAction(this.ACTIONS.CLICKED, 'clicked');
        }
      });

      //
      // Components
      //

      var BuzzerComponent = React.createClass({
        mixins : [dyna.DynaFluxMixin()],

        getInitialState : function() {
          return {
            status: this.props.status
          }
        },

        componentDidMount : function() {
          this.flux().store('BuzzerStore').addChangeListener(this._statusChanged);
        },

        render : function() {
          return (
              <div>
                <div>Buzzer - { this.state.status }</div>
                <button onClick={ this._buzzClick }>Buzz</button>
              </div>
          );
        },

        _buzzClick : function() {
          var click_action = action_factory.buzzClick();
          click_action.dispatch(this.flux().action_dispatcher);
        },

        _statusChanged : function() {
          this.setState({
            status: this.flux().store('BuzzerStore').getStatus()
          });
        }
      });

      //
      // Events
      //

      var event_names   = {
        STATUS_CHANGE: 'buzzer.status-change'
      };
      window.event_factory = dyna.createEventFactory(event_names, {
        statusChange : function(status) {
          return this.createEvent(this.EVENTS.STATUS_CHANGE, status);
        }
      });

      //
      // Coordinator
      //

      var Buzzer = function() {
        /**
         * Mount coordinator specific components
         * @param {MountFunction} mount - mount function
         */
        this.$mount = function(mount) {
          mount(document.getElementById('buzzer'), BuzzerComponent, { status: 'unclicked' });
        };

        /**
         * Un-mount coordinator specific components
         * @param {UnmountFunction} unmount - un-mount function
         */
        this.$unmount = function(unmount) {
          unmount(document.getElementById('buzzer'));
        };

        this.$listen = function() {
          return [
            { action: action_factory.ACTIONS.CLICKED, handler: _buzzClicked.bind(this) }
          ];
        };

        this.$start = function() {
        };

        //
        // Private Method
        //

        function _buzzClicked(event) {
          _setStatus.call(this, event.payload());
        }

        function _setStatus(status) {
          event_factory.statusChange(status).dispatch(this.flux.event_dispatcher);
        }
      };

      dyna.registerCoordinator('Buzzer', Buzzer);
    }(dyna, dyna.React));


    $(function() {
      (function(dyna) {
        var flux = dyna.flux(["Buzzer"], ["BuzzerStore"]);
        dyna.start(flux);
      }(dyna));
    });
  </script>
</head>
<body>
<div id="buzzer"></div>
</body>
</html>